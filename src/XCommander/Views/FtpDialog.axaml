<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="using:XCommander.Controls"
        xmlns:vm="using:XCommander.ViewModels"
        xmlns:services="using:XCommander.Services"
        xmlns:converters="using:XCommander.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="XCommander.Views.FtpDialog"
        x:DataType="vm:FtpViewModel"
        Title="FTP Connection"
        Width="1000"
        Height="700"
        WindowStartupLocation="CenterOwner">
    
    <Window.Resources>
        <converters:DateTimeConverter x:Key="DateTimeConverter"/>
        <DataTemplate x:Key="FtpItemNameTemplate"
                      x:DataType="services:FtpItem">
            <StackPanel Orientation="Horizontal" Spacing="6" Margin="4,2">
                <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="SavedConnectionTemplate"
                      x:DataType="vm:FtpConnectionViewModel">
            <StackPanel Margin="4">
                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding Host}" FontSize="11" Opacity="0.7"/>
            </StackPanel>
        </DataTemplate>
    </Window.Resources>
    
    <Grid ColumnDefinitions="250,*" Margin="10">
        <!-- Saved Connections Panel -->
        <controls:TcInsetPanel Grid.Column="0"
                               Padding="8"
                               Margin="0,0,8,0">
            <Grid RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0" 
                           Text="Saved Connections" 
                           FontWeight="Bold"
                           Margin="0,0,0,10"/>
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding SavedConnections}"
                          SelectedItem="{Binding SelectedSavedConnection}"
                          ColumnDefinitionsSource="{Binding SavedConnectionsColumnDefinitions}"
                          FilteringModel="{Binding SavedConnectionsFilteringModel}"
                          SortingModel="{Binding SavedConnectionsSortingModel}"
                          SearchModel="{Binding SavedConnectionsSearchModel}"
                          SelectionMode="Single"
                          CanUserResizeColumns="True"
                          CanUserReorderColumns="False"
                          CanUserSortColumns="True"
                          HeadersVisibility="None"
                          GridLinesVisibility="None"
                          BorderThickness="0"
                          IsReadOnly="True">
                    <DataGrid.FastPathOptions>
                        <DataGridFastPathOptions UseAccessorsOnly="True"
                                                 ThrowOnMissingAccessor="True" />
                    </DataGrid.FastPathOptions>
                </DataGrid>
                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="4" Margin="0,8,0,0">
                    <Button Content="Load" 
                            Command="{Binding LoadSelectedConnectionCommand}"
                            IsEnabled="{Binding SelectedSavedConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="8,4"/>
                    <Button Content="Delete" 
                            Command="{Binding DeleteSelectedConnectionCommand}"
                            IsEnabled="{Binding SelectedSavedConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="8,4"/>
                </StackPanel>
            </Grid>
        </controls:TcInsetPanel>
        
        <!-- Main Panel -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
            <!-- Connection Panel -->
            <controls:TcBevelPanel Grid.Row="0"
                                   Padding="6,4"
                                   Margin="0,0,0,6">
                <Grid RowDefinitions="Auto,Auto">
                    <!-- Connection fields -->
                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto,Auto,*,Auto,*">
                        <TextBlock Grid.Column="0" Text="Host:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding Host}" 
                                 Watermark="ftp.example.com"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="2" Text="Port:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="3" 
                                 Text="{Binding Port}" 
                                 Width="60"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="4" Text="User:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="5" 
                                 Text="{Binding Username}" 
                                 Watermark="anonymous"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="6" Text="Password:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="7" 
                                 Text="{Binding Password}" 
                                 PasswordChar="*"
                                 IsEnabled="{Binding !IsConnected}"/>
                    </Grid>
                    
                    <!-- Name and buttons -->
                    <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto,Auto,Auto" Margin="0,8,0,0">
                        <TextBlock Grid.Column="0" Text="Name:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding ConnectionName}" 
                                 Watermark="Connection name (optional)"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <Button Grid.Column="2" 
                                Content="Save"
                                Command="{Binding SaveCurrentConnectionCommand}"
                                IsEnabled="{Binding !IsConnected}"
                                Padding="8,4"
                                Margin="10,0,0,0"/>
                        <Button Grid.Column="3" 
                                Content="Connect"
                                Command="{Binding ConnectCommand}"
                                IsVisible="{Binding !IsConnected}"
                                IsEnabled="{Binding !IsConnecting}"
                                Padding="10,4"
                                Margin="4,0,0,0"/>
                        <Button Grid.Column="3" 
                                Content="Disconnect"
                                Command="{Binding DisconnectCommand}"
                                IsVisible="{Binding IsConnected}"
                                Padding="10,4"
                                Margin="4,0,0,0"/>
                    </Grid>
                </Grid>
            </controls:TcBevelPanel>
        
            <!-- File Browser -->
            <Grid Grid.Row="1" Margin="0,0,0,6" IsEnabled="{Binding IsConnected}">
                <Grid RowDefinitions="Auto,*">
                    <!-- Path Bar -->
                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,6">
                        <Button Grid.Column="0" 
                                Content="Up" 
                                Command="{Binding GoToParentCommand}"
                                Padding="8,4"
                                Margin="0,0,8,0"
                                ToolTip.Tip="Parent Directory"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding CurrentPath}"
                                 IsReadOnly="True"/>
                        <Button Grid.Column="2" 
                                Content="Refresh" 
                                Command="{Binding RefreshCommand}"
                                Padding="8,4"
                                Margin="8,0,0,0"
                                ToolTip.Tip="Refresh"/>
                    </Grid>
                    
                    <!-- File List -->
                    <controls:TcInsetPanel Grid.Row="1" Padding="0">
                        <DataGrid ItemsSource="{Binding Items}"
                                  SelectedItem="{Binding SelectedItem}"
                                  ColumnDefinitionsSource="{Binding ColumnDefinitions}"
                                  FilteringModel="{Binding FilteringModel}"
                                  SortingModel="{Binding SortingModel}"
                                  SearchModel="{Binding SearchModel}"
                                  SelectionMode="Single"
                                  CanUserResizeColumns="True"
                                  CanUserSortColumns="True"
                                  GridLinesVisibility="Horizontal"
                                  IsReadOnly="True"
                                  BorderThickness="0"
                                  FontSize="12"
                                  DoubleTapped="OnItemDoubleTapped">
                            <DataGrid.FastPathOptions>
                                <DataGridFastPathOptions UseAccessorsOnly="True"
                                                         ThrowOnMissingAccessor="True" />
                            </DataGrid.FastPathOptions>
                        </DataGrid>
                    </controls:TcInsetPanel>
                </Grid>
            </Grid>
            
            <!-- Status Bar -->
            <controls:TcBevelPanel Grid.Row="2"
                                   Padding="6,4"
                                   Margin="0,0,0,0">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" 
                               Text="{Binding StatusText}"
                               VerticalAlignment="Center"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                        <Button Content="Download" 
                                Click="OnDownloadClick"
                                IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Padding="8,4"/>
                        <Button Content="Upload" 
                                Click="OnUploadClick"
                                Padding="8,4"/>
                        <Button Content="New Folder" 
                                Click="OnNewFolderClick"
                                Padding="8,4"/>
                        <Button Content="Delete" 
                                Command="{Binding DeleteSelectedCommand}"
                                IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Padding="8,4"/>
                        <Button Content="Close" 
                                Click="OnCloseClick"
                                Padding="8,4"/>
                    </StackPanel>
                </Grid>
            </controls:TcBevelPanel>
        </Grid>
    </Grid>
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding $parent[Window].Close}"/>
        <KeyBinding Gesture="F5" Command="{Binding RefreshCommand}"/>
        <KeyBinding Gesture="Back" Command="{Binding GoToParentCommand}"/>
    </Window.KeyBindings>
</Window>
