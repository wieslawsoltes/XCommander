<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:XCommander.ViewModels"
        xmlns:services="using:XCommander.Services"
        xmlns:converters="using:XCommander.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="XCommander.Views.FtpDialog"
        x:DataType="vm:FtpViewModel"
        Title="FTP Connection"
        Width="1000"
        Height="700"
        WindowStartupLocation="CenterOwner">
    
    <Window.Resources>
        <converters:DateTimeConverter x:Key="DateTimeConverter"/>
    </Window.Resources>
    
    <Grid ColumnDefinitions="250,*">
        <!-- Saved Connections Panel -->
        <Border Grid.Column="0"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Margin="10"
                Padding="10"
                CornerRadius="4">
            <Grid RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0" 
                           Text="Saved Connections" 
                           FontWeight="Bold"
                           Margin="0,0,0,10"/>
                <ListBox Grid.Row="1" 
                         ItemsSource="{Binding SavedConnections}"
                         SelectedItem="{Binding SelectedSavedConnection}"
                         SelectionMode="Single">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:FtpConnectionViewModel">
                            <StackPanel Margin="4">
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding Host}" FontSize="11" Opacity="0.7"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="4" Margin="0,10,0,0">
                    <Button Content="Load" 
                            Command="{Binding LoadSelectedConnectionCommand}"
                            IsEnabled="{Binding SelectedSavedConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="10,4"/>
                    <Button Content="Delete" 
                            Command="{Binding DeleteSelectedConnectionCommand}"
                            IsEnabled="{Binding SelectedSavedConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="10,4"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Panel -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
            <!-- Connection Panel -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                    Padding="10"
                    Margin="0,10,10,0"
                    CornerRadius="4">
                <Grid RowDefinitions="Auto,Auto">
                    <!-- Connection fields -->
                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto,Auto,*,Auto,*">
                        <TextBlock Grid.Column="0" Text="Host:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding Host}" 
                                 Watermark="ftp.example.com"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="2" Text="Port:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="3" 
                                 Text="{Binding Port}" 
                                 Width="60"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="4" Text="User:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="5" 
                                 Text="{Binding Username}" 
                                 Watermark="anonymous"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <TextBlock Grid.Column="6" Text="Password:" VerticalAlignment="Center" Margin="10,0,8,0"/>
                        <TextBox Grid.Column="7" 
                                 Text="{Binding Password}" 
                                 PasswordChar="*"
                                 IsEnabled="{Binding !IsConnected}"/>
                    </Grid>
                    
                    <!-- Name and buttons -->
                    <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto,Auto,Auto" Margin="0,8,0,0">
                        <TextBlock Grid.Column="0" Text="Name:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding ConnectionName}" 
                                 Watermark="Connection name (optional)"
                                 IsEnabled="{Binding !IsConnected}"/>
                        
                        <Button Grid.Column="2" 
                                Content="Save"
                                Command="{Binding SaveCurrentConnectionCommand}"
                                IsEnabled="{Binding !IsConnected}"
                                Padding="12,6"
                                Margin="10,0,0,0"/>
                        <Button Grid.Column="3" 
                                Content="Connect"
                                Command="{Binding ConnectCommand}"
                                IsVisible="{Binding !IsConnected}"
                                IsEnabled="{Binding !IsConnecting}"
                                Padding="15,6"
                                Margin="4,0,0,0"/>
                        <Button Grid.Column="3" 
                                Content="Disconnect"
                                Command="{Binding DisconnectCommand}"
                                IsVisible="{Binding IsConnected}"
                                Padding="15,6"
                                Margin="4,0,0,0"/>
                    </Grid>
                </Grid>
            </Border>
        
            <!-- File Browser -->
            <Grid Grid.Row="1" Margin="0,10,10,0" IsEnabled="{Binding IsConnected}">
                <Grid RowDefinitions="Auto,*">
                    <!-- Path Bar -->
                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,8">
                        <Button Grid.Column="0" 
                                Content="↑" 
                                Command="{Binding GoToParentCommand}"
                                Padding="8,4"
                                Margin="0,0,8,0"
                                ToolTip.Tip="Parent Directory"/>
                        <TextBox Grid.Column="1" 
                                 Text="{Binding CurrentPath}"
                                 IsReadOnly="True"/>
                        <Button Grid.Column="2" 
                                Content="⟳" 
                                Command="{Binding RefreshCommand}"
                                Padding="8,4"
                                Margin="8,0,0,0"
                                ToolTip.Tip="Refresh"/>
                    </Grid>
                    
                    <!-- File List -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding Items}"
                              SelectedItem="{Binding SelectedItem}"
                              SelectionMode="Single"
                              CanUserResizeColumns="True"
                              GridLinesVisibility="Horizontal"
                              IsReadOnly="True"
                              FontSize="12"
                              DoubleTapped="OnItemDoubleTapped">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Name" Width="*" MinWidth="200">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="services:FtpItem">
                                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="4,2">
                                            <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Size" 
                                                Binding="{Binding DisplaySize}" 
                                                Width="100"/>
                            <DataGridTextColumn Header="Date Modified" 
                                                Binding="{Binding DateModified, Converter={StaticResource DateTimeConverter}}" 
                                                Width="140"/>
                            <DataGridTextColumn Header="Permissions" 
                                                Binding="{Binding Permissions}" 
                                                Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
            
            <!-- Status Bar -->
            <Border Grid.Row="2" 
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                    Padding="10,8"
                    Margin="0,10,10,10"
                    CornerRadius="4">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" 
                               Text="{Binding StatusText}"
                               VerticalAlignment="Center"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                        <Button Content="Download" 
                                Click="OnDownloadClick"
                                IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Padding="12,6"/>
                        <Button Content="Upload" 
                                Click="OnUploadClick"
                                Padding="12,6"/>
                        <Button Content="New Folder" 
                                Click="OnNewFolderClick"
                                Padding="12,6"/>
                        <Button Content="Delete" 
                                Command="{Binding DeleteSelectedCommand}"
                                IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Padding="12,6"/>
                        <Button Content="Close" 
                                Click="OnCloseClick"
                                Padding="12,6"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding $parent[Window].Close}"/>
        <KeyBinding Gesture="F5" Command="{Binding RefreshCommand}"/>
        <KeyBinding Gesture="Back" Command="{Binding GoToParentCommand}"/>
    </Window.KeyBindings>
</Window>
