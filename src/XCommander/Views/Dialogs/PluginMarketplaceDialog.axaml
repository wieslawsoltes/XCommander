<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="using:XCommander.Controls"
        xmlns:vm="using:XCommander.ViewModels"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="XCommander.Views.Dialogs.PluginMarketplaceDialog"
        x:DataType="vm:PluginMarketplaceViewModel"
        Title="Plugin Marketplace"
        Width="900"
        Height="650"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <DataTemplate x:Key="MarketplacePluginTemplate"
                      x:DataType="vm:MarketplacePluginItem">
            <Border Padding="8" Margin="2"
                    Background="{DynamicResource TcWindowBackgroundBrush}">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Icon -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding Icon}"
                               FontSize="28"
                               VerticalAlignment="Center"
                               Margin="0,0,15,0"/>
                    
                    <!-- Info -->
                    <StackPanel Grid.Column="1" Spacing="3">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14"/>
                            <TextBlock Text="{Binding Version}" Opacity="0.6" VerticalAlignment="Center"/>
                            <Border Background="Green" Padding="5,2"
                                    IsVisible="{Binding IsInstalled}">
                                <TextBlock Text="Installed" FontSize="10" Foreground="White"/>
                            </Border>
                            <Border Background="Orange" Padding="5,2"
                                    IsVisible="{Binding HasUpdate}">
                                <TextBlock Text="Update" FontSize="10" Foreground="White"/>
                            </Border>
                        </StackPanel>
                        <TextBlock Text="{Binding Description}"
                                   Opacity="0.7"
                                   TextTrimming="CharacterEllipsis"/>
                        <StackPanel Orientation="Horizontal" Spacing="15" Margin="0,3,0,0">
                            <TextBlock Text="{Binding Author, StringFormat='by {0}'}"
                                       FontSize="11" Opacity="0.5"/>
                            <TextBlock Text="{Binding Category}"
                                       FontSize="11" Opacity="0.5"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Action -->
                    <Button Grid.Column="2"
                            Content="Install"
                            Command="{Binding $parent[DataGrid].((vm:PluginMarketplaceViewModel)DataContext).InstallPluginCommand}"
                            CommandParameter="{Binding}"
                            VerticalAlignment="Center"
                            Padding="10,4"
                            IsVisible="{Binding !IsInstalled}"/>
                    <Button Grid.Column="2"
                            Content="Uninstall"
                            Command="{Binding $parent[DataGrid].((vm:PluginMarketplaceViewModel)DataContext).UninstallPluginCommand}"
                            CommandParameter="{Binding}"
                            VerticalAlignment="Center"
                            Padding="10,4"
                            IsVisible="{Binding IsInstalled}"/>
                </Grid>
            </Border>
        </DataTemplate>
    </Window.Resources>
    
    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto" Margin="10">
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="Plugin Marketplace" FontSize="14" FontWeight="Bold"/>
            <TextBlock Text="Discover, install, and manage plugins to extend XCommander functionality."
                       Foreground="{DynamicResource TcMutedTextBrush}" Margin="0,2,0,0"/>
        </StackPanel>
        
        <!-- Toolbar -->
        <controls:TcBevelPanel Grid.Row="1"
                               Padding="6,4"
                               Margin="0,0,0,6">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Search -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <TextBox Text="{Binding SearchQuery}" 
                             Width="250" 
                             Watermark="Search plugins..."/>
                    <ComboBox ItemsSource="{Binding Categories}" 
                              SelectedItem="{Binding SelectedCategory}"
                              Width="120"/>
                </StackPanel>
                
                <!-- Filters -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15" Margin="20,0" VerticalAlignment="Center">
                    <CheckBox IsChecked="{Binding ShowInstalled}" Content="Installed"/>
                    <CheckBox IsChecked="{Binding ShowAvailable}" Content="Available"/>
                </StackPanel>
                
                <!-- Actions -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="5">
                    <Button Content="Refresh" 
                            Command="{Binding RefreshMarketplaceCommand}"
                            Padding="8,4"/>
                    <Button Content="Check Updates" 
                            Command="{Binding CheckForUpdatesCommand}"
                            Padding="8,4"/>
                    <Button Content="Open Folder" 
                            Command="{Binding OpenPluginsFolderCommand}"
                            Padding="8,4"/>
                </StackPanel>
            </Grid>
        </controls:TcBevelPanel>
        
        <!-- Plugin List -->
        <controls:TcInsetPanel Grid.Row="2" Padding="0">
            <Grid ColumnDefinitions="*,300">
                <!-- List -->
                <DataGrid Grid.Column="0"
                          ItemsSource="{Binding FilteredPlugins}"
                          SelectedItem="{Binding SelectedMarketplacePlugin}"
                          ColumnDefinitionsSource="{Binding ColumnDefinitions}"
                          FilteringModel="{Binding FilteringModel}"
                          SortingModel="{Binding SortingModel}"
                          SearchModel="{Binding SearchModel}"
                          Padding="5"
                          CanUserResizeColumns="True"
                          CanUserReorderColumns="False"
                          CanUserSortColumns="True"
                          HeadersVisibility="None"
                          GridLinesVisibility="None"
                          BorderThickness="0"
                          IsReadOnly="True">
                    <DataGrid.FastPathOptions>
                        <DataGridFastPathOptions UseAccessorsOnly="True"
                                                 ThrowOnMissingAccessor="True" />
                    </DataGrid.FastPathOptions>
                </DataGrid>
                
                <!-- Details Panel -->
                <controls:TcInsetPanel Grid.Column="1"
                                       Padding="10"
                                       IsVisible="{Binding SelectedMarketplacePlugin, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <ScrollViewer>
                        <StackPanel Spacing="15" DataContext="{Binding SelectedMarketplacePlugin}">
                            <TextBlock Text="{Binding Icon}" FontSize="48" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding Name}" FontSize="18" FontWeight="SemiBold" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding Version, StringFormat='Version {0}'}" 
                                       HorizontalAlignment="Center" Foreground="{DynamicResource TcMutedTextBrush}"/>
                            
                            <Separator/>
                            
                            <TextBlock Text="Description" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding Description}" TextWrapping="Wrap"/>
                            
                            <TextBlock Text="Details" FontWeight="SemiBold" Margin="0,10,0,0"/>
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpan="10">
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Author:" Opacity="0.6" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Author}"/>
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Category:" Opacity="0.6" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Category}"/>
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Downloads:" Opacity="0.6" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Downloads}"/>
                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Rating:" Opacity="0.6" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Rating}"/>
                            </Grid>
                        </StackPanel>
                    </ScrollViewer>
                </controls:TcInsetPanel>
            </Grid>
        </controls:TcInsetPanel>
        
        <!-- Progress -->
        <ProgressBar Grid.Row="3"
                     IsIndeterminate="True"
                     IsVisible="{Binding IsLoading}"
                     Margin="0,6"/>
        
        <!-- Footer -->
        <controls:TcBevelPanel Grid.Row="4" Padding="6,4" Margin="0,6,0,0">
        <Grid ColumnDefinitions="*,Auto">
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="20" VerticalAlignment="Center">
                <TextBlock Text="{Binding InstalledCount, StringFormat='Installed: {0}'}" Foreground="{DynamicResource TcMutedTextBrush}"/>
                <TextBlock Text="{Binding AvailableCount, StringFormat='Available: {0}'}" Foreground="{DynamicResource TcMutedTextBrush}"/>
                <TextBlock Text="{Binding StatusText}"/>
            </StackPanel>
            <Button Grid.Column="1" Content="Close" Click="OnCloseClick" Padding="10,4"/>
        </Grid>
        </controls:TcBevelPanel>
    </Grid>
</Window>
