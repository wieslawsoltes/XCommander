<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="using:XCommander.Controls"
        xmlns:vm="using:XCommander.ViewModels"
        xmlns:converters="using:XCommander.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="XCommander.Views.SearchDialog"
        x:DataType="vm:SearchViewModel"
        Title="Search Files"
        Width="900"
        Height="700"
        WindowStartupLocation="CenterOwner">
    
    <Window.Resources>
        <converters:DateTimeConverter x:Key="DateTimeConverter"/>
        <DataTemplate x:Key="SearchResultNameTemplate"
                      x:DataType="vm:SearchResultItem">
            <StackPanel Orientation="Horizontal" Spacing="6" Margin="4,2">
                <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
            </StackPanel>
        </DataTemplate>
    </Window.Resources>
    
    <Grid RowDefinitions="Auto,*,Auto" Margin="10">
        <!-- Search Criteria -->
        <controls:TcBevelPanel Grid.Row="0" Padding="6,4" Margin="0,0,0,6">
            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                <!-- Templates Row -->
                <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                    <TextBlock Text="Templates:" VerticalAlignment="Center" Width="80"/>
                    <ComboBox ItemsSource="{Binding SavedTemplates}"
                              SelectedItem="{Binding SelectedTemplate}"
                              DisplayMemberBinding="{Binding Name}"
                              Width="200"
                              PlaceholderText="Select template..."/>
                    <Button Content="Load" 
                            Command="{Binding LoadTemplateCommand}"
                            CommandParameter="{Binding SelectedTemplate}"
                            IsEnabled="{Binding SelectedTemplate, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="8,4"/>
                    <Button Content="Delete"
                            Command="{Binding DeleteTemplateCommand}"
                            CommandParameter="{Binding SelectedTemplate}"
                            IsEnabled="{Binding SelectedTemplate, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="8,4"/>
                    <TextBlock Text="|" VerticalAlignment="Center" Opacity="0.3" Margin="10,0"/>
                    <TextBox Text="{Binding NewTemplateName}" 
                             Width="150" 
                             Watermark="New template name"/>
                    <Button Content="Save as Template" 
                            Command="{Binding SaveAsTemplateCommand}"
                            Padding="8,4"/>
                </StackPanel>
                
                <!-- Search Path -->
                <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                    <TextBlock Text="Search in:" VerticalAlignment="Center" Width="80"/>
                    <TextBox Text="{Binding SearchPath}" Width="400"/>
                    <Button Content="Browse..." Click="OnBrowseClick" Padding="8,4"/>
                </StackPanel>
                
                <!-- File Pattern & Text Search -->
                <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                    <TextBlock Text="File mask:" VerticalAlignment="Center" Width="80"/>
                    <TextBox Text="{Binding SearchPattern}" Width="150" ToolTip.Tip="e.g., *.txt;*.cs"/>
                    <TextBlock Text="Search for:" VerticalAlignment="Center" Margin="20,0,0,0"/>
                    <TextBox Text="{Binding SearchText}" Width="200" Watermark="Text to find"/>
                </StackPanel>
                
                <!-- Options Row 1 -->
                <StackPanel Grid.Row="3" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="15" Margin="0,0,0,10">
                    <CheckBox IsChecked="{Binding SearchInSubfolders}" Content="Include subfolders"/>
                    <CheckBox IsChecked="{Binding SearchInContent}" Content="Search in file content"/>
                    <CheckBox IsChecked="{Binding CaseSensitive}" Content="Case sensitive"/>
                    <CheckBox IsChecked="{Binding UseRegex}" Content="Use regex"/>
                    <CheckBox IsChecked="{Binding SearchHiddenFiles}" Content="Include hidden files"/>
                </StackPanel>
                
                <!-- Date Filter -->
                <StackPanel Grid.Row="4" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                    <TextBlock Text="Date from:" VerticalAlignment="Center"/>
                    <DatePicker SelectedDate="{Binding DateFrom}" Width="130"/>
                    <TextBlock Text="to:" VerticalAlignment="Center"/>
                    <DatePicker SelectedDate="{Binding DateTo}" Width="130"/>
                    <Button Content="Clear dates" Click="OnClearDatesClick" Padding="6,2"/>
                </StackPanel>
                
                <!-- Size Filter -->
                <StackPanel Grid.Row="5" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="Size from:" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding SizeFrom}" Width="100" Watermark="bytes"/>
                    <TextBlock Text="to:" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding SizeTo}" Width="100" Watermark="bytes"/>
                    <TextBlock Text="bytes" VerticalAlignment="Center" Opacity="0.7"/>
                </StackPanel>
            </Grid>
        </controls:TcBevelPanel>
        
        <!-- Results Grid -->
        <controls:TcInsetPanel Grid.Row="1" Padding="0">
            <DataGrid ItemsSource="{Binding Results}"
                      SelectedItem="{Binding SelectedResult}"
                      ColumnDefinitionsSource="{Binding ColumnDefinitions}"
                      FilteringModel="{Binding FilteringModel}"
                      SortingModel="{Binding SortingModel}"
                      SearchModel="{Binding SearchModel}"
                      SelectionMode="Extended"
                      CanUserResizeColumns="True"
                      CanUserReorderColumns="True"
                      CanUserSortColumns="True"
                      GridLinesVisibility="Horizontal"
                      IsReadOnly="True"
                      BorderThickness="0"
                      FontSize="12"
                      DoubleTapped="OnResultDoubleTapped">
                <DataGrid.FastPathOptions>
                    <DataGridFastPathOptions UseAccessorsOnly="True"
                                             ThrowOnMissingAccessor="True" />
                </DataGrid.FastPathOptions>
            </DataGrid>
        </controls:TcInsetPanel>
        
        <!-- Bottom Bar -->
        <controls:TcBevelPanel Grid.Row="2" Padding="6,4" Margin="0,6,0,0">
            <Grid ColumnDefinitions="*,Auto">
                <!-- Status -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <TextBlock Text="{Binding StatusText}"/>
                    <TextBlock Text="{Binding FilesFound, StringFormat='Files found: {0}'}" Foreground="{DynamicResource TcMutedTextBrush}"/>
                    <TextBlock Text="{Binding FilesSearched, StringFormat='Files searched: {0}'}" Foreground="{DynamicResource TcMutedTextBrush}"/>
                </StackPanel>
                
                <!-- Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                    <Button Content="Start Search" 
                            Command="{Binding StartSearchCommand}"
                            IsEnabled="{Binding !IsSearching}"
                            Padding="10,4"/>
                    <Button Content="Stop" 
                            Command="{Binding StopSearchCommand}"
                            IsEnabled="{Binding IsSearching}"
                            Padding="10,4"/>
                    <Button Content="Clear" 
                            Command="{Binding ClearResultsCommand}"
                            IsEnabled="{Binding !IsSearching}"
                            Padding="10,4"/>
                    <Button Content="Go to File" 
                            Click="OnGoToFileClick"
                            IsEnabled="{Binding SelectedResult, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Padding="10,4"/>
                    <Button Content="Feed to Panel" 
                            Click="OnFeedToPanelClick"
                            IsEnabled="{Binding Results.Count}"
                            Padding="10,4"/>
                    <Button Content="Close" 
                            Click="OnCloseClick"
                            Padding="10,4"/>
                </StackPanel>
            </Grid>
        </controls:TcBevelPanel>
    </Grid>
</Window>
