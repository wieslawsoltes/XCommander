<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:XCommander.ViewModels"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="500"
             x:Class="XCommander.Views.BookmarksPanel"
             x:DataType="vm:BookmarksViewModel">

    <UserControl.Resources>
        <DataTemplate x:Key="BookmarkItemTemplate"
                      x:DataType="vm:BookmarkItemViewModel">
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="4,2">
                <TextBlock Text="{Binding Icon}" FontSize="16" VerticalAlignment="Center" Width="24"/>
                <StackPanel Grid.Column="1" Margin="8,0">
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding Path}" FontSize="10"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               TextTrimming="CharacterEllipsis"/>
                </StackPanel>
                <Button Grid.Column="2" Content="Ã—" Padding="4,0"
                        Command="{Binding $parent[UserControl].((vm:BookmarksViewModel)DataContext).RemoveBookmarkCommand}"
                        CommandParameter="{Binding}"
                        Background="Transparent"
                        ToolTip.Tip="Remove bookmark"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="RecentLocationTemplate"
                      x:DataType="sys:String">
            <TextBlock Text="{Binding}" FontSize="11"
                       TextTrimming="CharacterEllipsis"
                       Margin="4,2"/>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid RowDefinitions="Auto,*,Auto,Auto">
        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="12,8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="Bookmarks" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                <Button Grid.Column="1" Content="+" ToolTip.Tip="Add current folder" 
                        Padding="8,2"
                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).AddCurrentFolderToBookmarksCommand}"/>
            </Grid>
        </Border>
        
        <!-- Bookmarks List -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding Bookmarks}"
                  SelectedItem="{Binding SelectedBookmark}"
                  ColumnDefinitionsSource="{Binding BookmarksColumnDefinitions}"
                  FilteringModel="{Binding BookmarksFilteringModel}"
                  SortingModel="{Binding BookmarksSortingModel}"
                  SearchModel="{Binding BookmarksSearchModel}"
                  Background="Transparent"
                  Padding="4"
                  SelectionMode="Single"
                  CanUserResizeColumns="True"
                  CanUserReorderColumns="False"
                  CanUserSortColumns="True"
                  HeadersVisibility="None"
                  GridLinesVisibility="None"
                  BorderThickness="0"
                  IsReadOnly="True"
                  DoubleTapped="OnBookmarkDoubleTapped">
            <DataGrid.ContextFlyout>
                <MenuFlyout>
                    <MenuItem Header="Go to" Command="{Binding NavigateToBookmarkCommand}"
                              CommandParameter="{Binding SelectedBookmark}"/>
                    <Separator/>
                    <MenuItem Header="Move Up" Command="{Binding MoveBookmarkUpCommand}"
                              CommandParameter="{Binding SelectedBookmark}"/>
                    <MenuItem Header="Move Down" Command="{Binding MoveBookmarkDownCommand}"
                              CommandParameter="{Binding SelectedBookmark}"/>
                    <Separator/>
                    <MenuItem Header="Remove" Command="{Binding RemoveBookmarkCommand}"
                              CommandParameter="{Binding SelectedBookmark}"/>
                </MenuFlyout>
            </DataGrid.ContextFlyout>
            <DataGrid.FastPathOptions>
                <DataGridFastPathOptions UseAccessorsOnly="True"
                                         ThrowOnMissingAccessor="True" />
            </DataGrid.FastPathOptions>
        </DataGrid>
        
        <!-- Recent Locations -->
        <Expander Grid.Row="2" Header="Recent Locations" IsExpanded="False" Margin="4">
            <Grid RowDefinitions="*,Auto" MaxHeight="150">
                <DataGrid ItemsSource="{Binding RecentLocations}"
                          ColumnDefinitionsSource="{Binding RecentColumnDefinitions}"
                          FilteringModel="{Binding RecentFilteringModel}"
                          SortingModel="{Binding RecentSortingModel}"
                          SearchModel="{Binding RecentSearchModel}"
                          Background="Transparent"
                          SelectionMode="Single"
                          CanUserResizeColumns="True"
                          CanUserReorderColumns="False"
                          CanUserSortColumns="True"
                          HeadersVisibility="None"
                          GridLinesVisibility="None"
                          BorderThickness="0"
                          IsReadOnly="True"
                          DoubleTapped="OnRecentDoubleTapped">
                    <DataGrid.FastPathOptions>
                        <DataGridFastPathOptions UseAccessorsOnly="True"
                                                 ThrowOnMissingAccessor="True" />
                    </DataGrid.FastPathOptions>
                </DataGrid>
                <Button Grid.Row="1" Content="Clear Recent" HorizontalAlignment="Right"
                        Command="{Binding ClearRecentLocationsCommand}"
                        Margin="4" Padding="8,4" FontSize="11"/>
            </Grid>
        </Expander>
        
        <!-- Add New Bookmark -->
        <Expander Grid.Row="3" Header="Add Bookmark" IsExpanded="False" Margin="4">
            <StackPanel Spacing="8" Margin="8">
                <TextBox Text="{Binding NewBookmarkName}" Watermark="Name (optional)"/>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBox Text="{Binding NewBookmarkPath}" Watermark="Path"/>
                    <Button Grid.Column="1" Content="..." Margin="4,0,0,0" Click="OnBrowseClick"/>
                </Grid>
                <Button Content="Add Bookmark" Command="{Binding AddBookmarkCommand}"
                        HorizontalAlignment="Right"/>
            </StackPanel>
        </Expander>
    </Grid>
</UserControl>
