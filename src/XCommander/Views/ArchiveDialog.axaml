<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:XCommander.ViewModels"
             x:Class="XCommander.Views.ArchiveDialog"
             x:DataType="vm:ArchiveViewModel"
             MinWidth="800"
             MinHeight="500">
    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto">
        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource SystemAccentColor}" Padding="16">
            <Grid ColumnDefinitions="Auto,*">
                <TextBlock Text="ðŸ“¦ " FontSize="18"/>
                <TextBlock Grid.Column="1" Text="{Binding ArchiveName}" FontSize="18" FontWeight="Bold" Foreground="White"/>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{DynamicResource SystemRegionBrush}" Padding="8">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                <!-- Path & Actions -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                    <Button Content="â¬†ï¸ Up" Command="{Binding NavigateToCommand}" 
                            CommandParameter="{Binding Entries[0]}"
                            IsEnabled="{Binding CurrentPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            ToolTip.Tip="Go to parent folder"/>
                    <TextBlock Text="Path:" VerticalAlignment="Center" Margin="8,0,4,0"/>
                    <TextBlock Text="{Binding CurrentPath}" VerticalAlignment="Center" 
                               FontFamily="Consolas,Monaco,monospace"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="ðŸ“¥ Add Files" Command="{Binding RequestAddFilesCommand}" 
                            IsEnabled="{Binding !IsOperationInProgress}"
                            ToolTip.Tip="Add files to archive (ZIP only)"/>
                    <Button Content="ðŸ—‘ Delete" Command="{Binding DeleteSelectedFromArchiveCommand}" 
                            IsEnabled="{Binding !IsOperationInProgress}"
                            ToolTip.Tip="Delete selected entries from archive"/>
                    <Separator Width="1" Background="Gray" Margin="4,2"/>
                    <Button Content="Extract All" Click="ExtractAll_Click" 
                            IsEnabled="{Binding !IsOperationInProgress}"
                            ToolTip.Tip="Extract all files to a folder"/>
                    <Button Content="Extract Selected" Click="ExtractSelected_Click" 
                            IsEnabled="{Binding !IsOperationInProgress}"
                            ToolTip.Tip="Extract selected files"/>
                    <Button Content="Test" Command="{Binding TestArchiveCommand}" 
                            IsEnabled="{Binding !IsOperationInProgress}"
                            ToolTip.Tip="Test archive integrity"/>
                    <Button Content="Cancel" Command="{Binding CancelCommand}" 
                            IsEnabled="{Binding IsOperationInProgress}"/>
                </StackPanel>

                <!-- Selection -->
                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                            Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                    <Button Content="Select All" Command="{Binding SelectAllCommand}" Padding="8,4"/>
                    <Button Content="Select None" Command="{Binding SelectNoneCommand}" Padding="8,4"/>
                    <Separator Width="1" Background="Gray" Margin="8,0"/>
                    <TextBlock VerticalAlignment="Center">
                        <Run Text="Files: "/>
                        <Run Text="{Binding FileCount}" FontWeight="Bold"/>
                        <Run Text=" | Folders: "/>
                        <Run Text="{Binding FolderCount}" FontWeight="Bold"/>
                        <Run Text=" | Size: "/>
                        <Run Text="{Binding TotalSizeDisplay}" FontWeight="Bold"/>
                        <Run Text=" â†’ "/>
                        <Run Text="{Binding TotalCompressedSizeDisplay}" FontWeight="Bold"/>
                        <Run Text=" ("/>
                        <Run Text="{Binding CompressionRatioDisplay}" FontWeight="Bold"/>
                        <Run Text=" saved)"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>

        <!-- File List -->
        <DataGrid Grid.Row="2" ItemsSource="{Binding Entries}" 
                  AutoGenerateColumns="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  SelectionMode="Extended"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  Margin="8"
                  DoubleTapped="DataGrid_DoubleTapped">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected}" Width="30"/>
                <DataGridTextColumn Header="" Binding="{Binding Icon}" Width="30"/>
                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*"/>
                <DataGridTextColumn Header="Size" Binding="{Binding SizeDisplay}" Width="100"/>
                <DataGridTextColumn Header="Packed" Binding="{Binding CompressedSizeDisplay}" Width="100"/>
                <DataGridTextColumn Header="Ratio" Binding="{Binding RatioDisplay}" Width="60"/>
                <DataGridTextColumn Header="Date" Binding="{Binding DateDisplay}" Width="130"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Progress -->
        <Border Grid.Row="3" Background="{DynamicResource SystemRegionBrush}" Padding="8" 
                IsVisible="{Binding IsOperationInProgress}">
            <ProgressBar Value="{Binding Progress}" Minimum="0" Maximum="100" Height="4"/>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="4" Background="{DynamicResource SystemRegionBrush}" Padding="8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding Status}" VerticalAlignment="Center"/>
                <Button Grid.Column="1" Content="Close" Click="Close_Click" Width="80"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
